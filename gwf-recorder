#!/bin/bash
CONFIG_FILE="$HOME/.config/gwfrecorder.conf"
mkdir -p "$(dirname "$CONFIG_FILE")"

if [ -z "${TERMINAL}" ]; then
	echo "WARNING: \$TERMINAL environment variable is empty, assuming x-terminal-emulator"
	TERMINAL=x-terminal-emulator
fi

if [ -f "$CONFIG_FILE" ]; then
	source "$CONFIG_FILE"
fi

displays="$(wlr-randr | grep -v '^ ' | awk '{print $1}' | paste -sd '!' -)"
video_codecs="$(ffmpeg -hide_banner -encoders | grep -i "^ V" | awk '{print $2}' | tail -n +2 | paste -sd '!' -)"
audio_codecs="$(ffmpeg -hide_banner -encoders | grep -i "^ A" | awk '{print $2}' | tail -n +2 | paste -sd '!' -)"
audio_inputs="$(pactl list sources | grep Name | awk -F': ' '{print $2}' | paste -sd '!' -)"

# move saved value to front of list because filling entry is not working
move_to_front()
{
	local saved="$1"
	local list="$2"
	if [ -n "$saved" ] && echo "$list" | grep -q "$saved"; then
		# Remove saved from list and prepend it
		list=$(echo "$list" | tr '!' '\n' | grep -v "^${saved}$" | paste -sd '!' -)
		echo "${saved}!${list}"
	else
		echo "$list"
	fi
}

displays=$(move_to_front "$display" "$displays")
video_codecs=$(move_to_front "$video_codec" "$video_codecs")
audio_codecs=$(move_to_front "$audio_codec" "$audio_codecs")
audio_inputs=$(move_to_front "$audio_input" "$audio_inputs")

result=$(yad --title="GWF Recorder" --text="Configure video details:" \
	--form \
	--field="File Name":SFL "${file_name:-/home/$USER/recording.mkv}" \
	--field="Frame Rate":NUM "${frame_rate:-60}" \
	--field="Display":CBE "$displays" \
	--field="Video Codec":CBE "$video_codecs" \
	--field="Record audio":CHK "${record_audio:-FALSE}" \
	--field="Audio Codec":CBE "$audio_codecs" \
	--field="Audio Input":CBE "$audio_inputs" \
	--field="Run in a terminal":CHK "${run_in_terminal:-FALSE}")

if [ $? -ne 0 ]; then
	exit 1
fi

IFS='|' read -r file_name frame_rate display video_codec record_audio audio_codec audio_input run_in_terminal <<< "$result"

cat > "$CONFIG_FILE" <<EOF
file_name="$file_name"
frame_rate="$frame_rate"
display="$display"
video_codec="$video_codec"
record_audio="$record_audio"
audio_codec="$audio_codec"
audio_input="$audio_input"
run_in_terminal="$run_in_terminal"
EOF

if [ -z "${file_name}" ]; then
	echo "WARNING: File name is empty, using /home/$USER/recording.mkv"
	file_name="/home/$USER/recording.mkv"
fi

base="${file_name%.*}"
ext="${file_name##*.}"
count=1

while [ -e "$file_name" ]; do
	file_name="${base}_${count}.${ext}"
	((count++))
done

echo "Output file: $file_name"

if [ "$record_audio" = "TRUE" ]; then
	audiocmd="--audio=$audio_input -C $audio_codec"
else
	audiocmd=""
fi

command="wf-recorder -o $display -r $frame_rate -c $video_codec $audiocmd -f \"$file_name\""

postrun() {
	wf_pid=$1
	(
		while kill -0 "$wf_pid" 2>/dev/null; do
			sleep 1
		done
		echo "Recording stopped."
	) & monitor_pid=$!

	yad --title="GWF Recorder" \
		--button="Stop:1" \
		--text="Recording in progress...\n\nPress Stop to end recording."

	if [ $? -eq 1 ]; then
		pkill -INT -P "$wf_pid" 2>/dev/null || kill -INT "$wf_pid" 2>/dev/null
	fi

	wait "$monitor_pid"
}

if [ "$run_in_terminal" = "TRUE" ]; then
	$TERMINAL -e bash -c "$command" &
	wf_pid=$!
else
	eval "$command" &
	wf_pid=$!
fi

postrun "$wf_pid"